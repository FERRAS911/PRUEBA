<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8"></meta>
		<meta content="width=device-width, initial-scale=1.0" name="viewport"></meta>
		<title>Asistencia - Administrar grupos</title>
		<meta content="#4b0082" name="msapplication-TileColor"></meta>
		<meta content="icons/ms-icon-144x144.png" name="msapplication-TileImage"></meta>
		<meta content="#4b0082" name="theme-color"></meta>
		<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet"></link>
		<link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet"></link>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
		<script src="https://cdn.tailwindcss.com"></script>

		<style>
			.bg-indigo {
				background-color: #4b0082;
			}
		</style>
	</head>
	<body class="bg-gray-100">
		<nav class="navbar navbar-expand-lg navbar-dark bg-blue-600">
			<div class="container-fluid">
				<a class="navbar-brand" href="index.html"><em><b>← Regresar</b></em></a>
			</div>
		</nav>
            
		<div class="container mt-5">
						<h1 class="text-3xl font-bold mb-6 text-center">
				Gestor de grupos de personas
			</h1>
			<button class="btn btn-primary mb-3" id="crearGrupo">
				Crear Nuevo Grupo
			</button>
			<div id="listaGrupos"></div>
		</div>

		<!-- Modal para crear/editar grupo -->
		<div class="modal fade" id="grupoModal" tabindex="-1">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="grupoModalLabel">Crear/Editar Grupo</h5>
						<button class="btn-close" data-bs-dismiss="modal" type="button"></button>
					</div>
					<div class="modal-body">
						<input class="form-control mb-3" id="nombreGrupo" placeholder="Nombre del Grupo" type="text" />
						<h6>Personas en el Grupo:</h6>
						<ul class="list-group mb-3" id="listaPersonas"></ul>
						<div class="input-group mb-3">
							<input class="form-control" id="nombrePersona" placeholder="Nombre de la Persona" type="text" />
							<input class="form-control" id="telefonoPersona" placeholder="Teléfono" type="tel" />
							<button class="btn btn-outline-secondary" id="agregarPersona" type="button">
								Agregar
							</button>
						</div>
					</div>
					<div class="modal-footer">
						<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">
							Cerrar
						</button>
						<button class="btn btn-primary" id="guardarGrupo" type="button">
							Guardar Grupo
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Modal para editar persona -->
		<div class="modal fade" id="editarPersonaModal" tabindex="-1">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Editar Persona</h5>
						<button class="btn-close" data-bs-dismiss="modal" type="button"></button>
					</div>
					<div class="modal-body">
						<input class="form-control mb-3" id="editNombrePersona" placeholder="Nombre de la Persona" type="text" />
						<input class="form-control mb-3" id="editTelefonoPersona" placeholder="Teléfono" type="tel" />
					</div>
					<div class="modal-footer">
						<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">
							Cerrar
						</button>
						<button class="btn btn-primary" id="guardarEditarPersona" type="button">
							Guardar Cambios
						</button>
					</div>
				</div>
			</div>
		</div>

		<script>
			$(document).ready(function () {
				let grupos = JSON.parse(localStorage.getItem("grupos")) || {};
				let grupoActual = null;
				let personaEditando = null;

				function actualizarListaGrupos() {
					let listaHTML = "";
					for (let id in grupos) {
						listaHTML += `
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">${grupos[id].nombre}</h5>
                                <p class="card-text">Personas: ${grupos[id].personas.length}</p>
                                <button class="btn btn-info editarGrupo" data-id="${id}">Editar</button>
                                <button class="btn btn-danger eliminarGrupo" data-id="${id}">Eliminar</button>
                            </div>
                        </div>
                    `;
					}
					$("#listaGrupos").html(listaHTML);
				}

				function generarId() {
					const caracteres = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
					let id;
					do {
						id = "";
						for (let i = 0; i < 4; i++) {
							id += caracteres.charAt(
								Math.floor(Math.random() * caracteres.length)
							);
						}
					} while (grupoActual && grupoActual.personas.some((p) => p.id === id));
					return id;
				}

				function limpiarTelefono(telefono) {
					// Eliminar todos los caracteres que no sean dígitos
					telefono = telefono.replace(/\D/g, "");

					// Si el número no comienza con 521 y tiene 10 dígitos, agregar 521
					if (!telefono.startsWith("521") && telefono.length === 10) {
						telefono = "521" + telefono;
					}

					// Si el número ya comienza con 521, asegurarse de que tenga 13 dígitos en total
					if (telefono.startsWith("521") && telefono.length > 13) {
						telefono = telefono.slice(0, 13);
					}

					return telefono;
				}

				$("#crearGrupo").click(function () {
					grupoActual = { nombre: "", personas: [] };
					$("#nombreGrupo").val("");
					$("#listaPersonas").empty();
					$("#grupoModalLabel").text("Crear Nuevo Grupo");
					$("#grupoModal").modal("show");
				});

				$(document).on("click", ".editarGrupo", function () {
					const id = $(this).data("id");
					grupoActual = JSON.parse(JSON.stringify(grupos[id])); // Clonar el grupo para evitar modificar directamente
					grupoActual.id = id;
					$("#nombreGrupo").val(grupoActual.nombre);
					actualizarListaPersonas();
					$("#grupoModalLabel").text("Editar Grupo");
					$("#grupoModal").modal("show");
				});

				$(document).on("click", ".eliminarGrupo", function () {
					const id = $(this).data("id");
					delete grupos[id];
					localStorage.setItem("grupos", JSON.stringify(grupos));
					actualizarListaGrupos();
				});

				$("#agregarPersona").click(function () {
					const nombre = $("#nombrePersona").val().trim();
					let telefono = $("#telefonoPersona").val().trim();
					if (nombre && telefono) {
						telefono = limpiarTelefono(telefono);
						const id = generarId();
						grupoActual.personas.push({ id, nombre, telefono });
						$("#nombrePersona").val("");
						$("#telefonoPersona").val("");
						actualizarListaPersonas();
					}
				});

				function actualizarListaPersonas() {
					let listaHTML = "";
					for (let persona of grupoActual.personas) {
						listaHTML += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${persona.nombre} - ${persona.telefono} 
                            <span class="badge bg-primary rounded-pill">${persona.id}</span>
                            <div>
                                <button class="btn btn-sm btn-warning editarPersona" data-id="${persona.id}">Editar</button>
                                <button class="btn btn-sm btn-danger eliminarPersona" data-id="${persona.id}">Eliminar</button>
                            </div>
                        </li>
                    `;
					}
					$("#listaPersonas").html(listaHTML);
				}

				$(document).on("click", ".eliminarPersona", function () {
					const id = $(this).data("id");
					grupoActual.personas = grupoActual.personas.filter(
						(p) => p.id !== id
					);
					actualizarListaPersonas();
				});

				$(document).on("click", ".editarPersona", function () {
					const id = $(this).data("id");
					personaEditando = grupoActual.personas.find((p) => p.id === id);
					$("#editNombrePersona").val(personaEditando.nombre);
					$("#editTelefonoPersona").val(personaEditando.telefono);
					$("#editarPersonaModal").modal("show");
				});

				$("#guardarEditarPersona").click(function () {
					const nuevoNombre = $("#editNombrePersona").val().trim();
					let nuevoTelefono = $("#editTelefonoPersona").val().trim();
					if (nuevoNombre && nuevoTelefono) {
						nuevoTelefono = limpiarTelefono(nuevoTelefono);
						personaEditando.nombre = nuevoNombre;
						personaEditando.telefono = nuevoTelefono;
						actualizarListaPersonas();
						$("#editarPersonaModal").modal("hide");
					}
				});

				$("#guardarGrupo").click(function () {
					const nombre = $("#nombreGrupo").val().trim();
					if (nombre) {
						grupoActual.nombre = nombre;
						const id = grupoActual.id || Date.now().toString();
						grupos[id] = grupoActual;
						localStorage.setItem("grupos", JSON.stringify(grupos));
						$("#grupoModal").modal("hide");
						actualizarListaGrupos();
					}
				});

				actualizarListaGrupos();
			});
		</script>

	</body>
</html>
