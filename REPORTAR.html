<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Asistencia - Ver Reportes</title>

		<meta name="msapplication-TileColor" content="#4b0082" />
		<meta name="msapplication-TileImage" content="icons/ms-icon-144x144.png" />
		<meta name="theme-color" content="#4b0082" />

		<link
			href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css"
			rel="stylesheet"
		/>
		<link
			href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"
			rel="stylesheet"
		/>
		<link
			href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css"
			rel="stylesheet"
		/>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"></script>
		<script src="https://cdn.tailwindcss.com"></script>

		<style>
			.bg-indigo {
				background-color: #008263;
			}
			.attendance-table {
				overflow-x: auto;
			}
			.attendance-table table {
				border-collapse: collapse;
				width: 100%;
			}
			.attendance-table th,
			.attendance-table td {
				border: 1px solid #ddd;
				padding: 8px;
				text-align: center;
			}
			.attendance-table th {
				background-color: #f2f2f2;
			}
		</style>
	</head>
	<body class="bg-gray-100">
			<nav class="navbar navbar-expand-lg navbar-dark bg-blue-600">
			<div class="container-fluid">
				<a class="navbar-brand" href="index.html"><em><b>← Regresar</b></em></a>
			</div>
		</nav>
		<div class="container mx-auto px-4 py-8">
			<h1 class="text-3xl font-bold mb-6 text-center">
				Reporte de Asistencias
			</h1>

			<div id="groupSelection" class="mb-8">
				<label for="groupSelect" class="block mb-2 font-semibold"
					>Selecciona un grupo:</label
				>
				<select id="groupSelect" class="w-full p-2 border rounded">
					<option value="">Selecciona un grupo...</option>
				</select>
			</div>

			<div class="mt-8">
				<h2 class="text-2xl font-semibold mb-4">Seleccionar Fechas</h2>
				<div class="flex space-x-4">
					<label for="startDate" class="block mb-2 font-semibold"
						>Fecha inicial:</label
					>
					<input
						type="text"
						id="startDate"
						class="w-1/2 p-2 border rounded"
						placeholder="Fecha inicial"
					/>
					<label for="endDate" class="block mb-2 font-semibold"
						>Fecha final:</label
					>
					<input
						type="text"
						id="endDate"
						class="w-1/2 p-2 border rounded"
						placeholder="Fecha final"
					/>
				</div>
				<button
					id="exportCsv"
					class="mt-4 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
				>
					Exportar a CSV
				</button>
			</div>

			<div id="attendanceList" class="mt-8 attendance-table hidden">
				<h2 class="text-2xl font-semibold mb-4">Lista de Asistencias</h2>
				<div id="attendanceTable"></div>
			</div>
		</div>

		<script>
			$(document).ready(function () {
				let currentGroup = null;
				const grupos = JSON.parse(localStorage.getItem("grupos")) || {};

				// Populate group select
				for (const [id, group] of Object.entries(grupos)) {
					$("#groupSelect").append(
						$("<option>", {
							value: id,
							text: group.nombre
						})
					);
				}

				// Initialize date pickers
				flatpickr("#startDate", {
					dateFormat: "Y-m-d",
					onChange: updateAttendanceList
				});
				flatpickr("#endDate", {
					dateFormat: "Y-m-d",
					onChange: updateAttendanceList
				});

				// Group selection
				$("#groupSelect").change(function () {
					currentGroup = $(this).val();
					if (currentGroup) {
						$("#attendanceList").removeClass("hidden");
						updateAttendanceList();
					} else {
						$("#attendanceList").addClass("hidden");
					}
				});

				// Seleccionar automáticamente el primer grupo
				if (Object.keys(grupos).length > 0) {
					$("#groupSelect").val(Object.keys(grupos)[0]);
					$("#groupSelect").change();
				}

				// Establecer la fecha actual como el valor predeterminado del campo de fecha final
				$("#endDate").val(new Date().toISOString().split("T")[0]);

				// Establecer el lunes más reciente como el valor predeterminado del campo de fecha inicial
				$("#startDate").val(
					new Date(
						new Date().setDate(new Date().getDate() - new Date().getDay())
					)
						.toISOString()
						.split("T")[0]
				);

				function updateAttendanceList() {
					const startDate = $("#startDate").val();
					const endDate = $("#endDate").val();

					if (!startDate || !endDate || !currentGroup) {
						return;
					}

					const attendance =
						JSON.parse(localStorage.getItem("attendance")) || {};
					const groupAttendance = attendance[currentGroup] || {};
					const group = grupos[currentGroup];

					// Generate array of dates between start and end
					const dateArray = [];
					const start = new Date(startDate);
					const end = new Date(endDate);
					for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
						dateArray.push(d.toISOString().split("T")[0]);
					}

					// Create table
					let tableContent = "<table><tr><th>Nombre/ID</th>";
					dateArray.forEach((date) => {
						tableContent += `<th>${date}</th>`;
					});
					tableContent += "</tr>";

					// Add data for each student
					group.personas.forEach((student) => {
						tableContent += `<tr><td>${student.nombre} (${student.id})</td>`;
						dateArray.forEach((date) => {
							const isPresent =
								groupAttendance[date] &&
								groupAttendance[date].includes(student.id);
							tableContent += `<td>${isPresent ? "✅" : "❌"}</td>`;
						});
						tableContent += "</tr>";
					});

					tableContent += "</table>";
					$("#attendanceTable").html(tableContent);
				}

				// Export to CSV
				$("#exportCsv").click(function () {
					const startDate = $("#startDate").val();
					const endDate = $("#endDate").val();

					if (!startDate || !endDate || !currentGroup) {
						alert(
							"Por favor, seleccione un grupo y un rango de fechas válido."
						);
						return;
					}

					const attendance =
						JSON.parse(localStorage.getItem("attendance")) || {};
					const groupAttendance = attendance[currentGroup] || {};
					const group = grupos[currentGroup];

					// Generate array of dates between start and end
					const dateArray = [];
					const start = new Date(startDate);
					const end = new Date(endDate);
					for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
						dateArray.push(d.toISOString().split("T")[0]);
					}

					// Create CSV header
					let csvContent = "data:text/csv;charset=utf-8,Nombre/ID,";
					csvContent += dateArray.join(",") + "\n";

					// Add data for each student
					group.personas.forEach((student) => {
						csvContent += `${student.nombre} (${student.id}),`;
						csvContent +=
							dateArray
								.map((date) => {
									return groupAttendance[date] &&
										groupAttendance[date].includes(student.id)
										? "1"
										: "0";
								})
								.join(",") + "\n";
					});

					const encodedUri = encodeURI(csvContent);
					const link = document.createElement("a");
					link.setAttribute("href", encodedUri);
					link.setAttribute(
						"download",
						`asistencia_${currentGroup}_${startDate}_${endDate}.csv`
					);
					document.body.appendChild(link);
					link.click();
				});

				// Initial update of attendance list
				updateAttendanceList();
			});
		</script>
	</body>
</html>
